apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-example
  namespace: default
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: backend-ratelimit
  jwt:
    providers:
      - name: example
        issuer: "testing@secure.istio.io"
        remoteJWKS:
          uri: https://raw.githubusercontent.com/istio/istio/master/security/tools/jwt/samples/jwks.json
---
apiVersion: aigateway.envoyproxy.io/v1alpha1
kind: LLMRoute
metadata:
  name: ratelimit-jwt-claim
  namespace: default
spec:
  targetRefs:
    - name: test-aig-ratelimit
      kind: Gateway
      group: gateway.networking.k8s.io
  backends:
    - backendRef:
        name: backend-ratelimit
        kind: Backend
        group: gateway.envoyproxy.io
      trafficPolicy:
        rateLimit:
          rules:
            - headers:
                - name: x-ai-gateway-llm-model-name
                  type: Exact
                  value: gpt-4o-mini
              metadata:
              - name: "envoy.filters.http.jwt_authn"
                paths:
                - testing@secure.istio.io
                - foo
              limits:
                - type: Token
                  quantity: 10
                  unit: Hour
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
  name: backend-ratelimit
  namespace: default
spec:
  endpoints:
    - fqdn:
        hostname: testupstream.default.svc.cluster.local
        port: 80
